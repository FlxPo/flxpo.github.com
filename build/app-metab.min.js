var app=app||{};app.FlowCollection=Backbone.Collection.extend({model:app.Flow});var app=app||{};app.Circle=Backbone.Model.extend({initialize:function(a){var b=2*Math.random()*Math.PI,c=Math.floor(25+40*Math.random())/2,d=Math.floor(175+c*(1.5*Math.random()-1)),e=Math.floor(5+20*Math.random()),f=Math.floor(a.cx+d*Math.cos(b)),g=Math.floor(a.cy+d*Math.sin(b)),h=Math.floor(100*(.4+Math.random()/3))/100,i=.36+.2*Math.random(),j=Raphael.hsl(i,1,.4);this.set({x:f,y:g,rad:c,col:j,op:h,sw:e})}});var app=app||{};app.Flow=Backbone.Model.extend({defaults:{flowLabel:"Name of the flow",flowVolume:{o4:35,o9:55},unit:"X/an",geometry:{type:"path",stroke:"#000"},pulse:{type:"circle",fill:"#f0f",stroke:"none"}},initialize:function(){var a=this.get("color");this.set({n_color:utils.darkenColor(a,.7)}),this.set({a_color:utils.darkenColor(a,.6)});var b=this.get("children"),c=this.get("parent"),d=this.get("siblings");b&&this.set("children",""===b?void 0:b.split(";")),c&&this.set("parent",""===c?void 0:c),d&&this.set("siblings",""===d?void 0:d.split(";").concat(this.get("id")));var e=this.get("volume_o4"),f=this.get("volume_o9");e="NA"===e?-1:parseInt(e.replace(/\s+/g,"")),f="NA"===f?-1:parseInt(f.replace(/\s+/g,"")),this.set("volume_o4",e),this.set("volume_o9",f);var g="true"==this.get("root"),h="true"==this.get("leaf");this.set("root",g),this.set("leaf",h),this.set("level",parseInt(this.get("level")))}});var app=app||{};app.FlowTip=Backbone.Model.extend({defaults:{flowLabel:"Name of the flow",flowVolume:"X unit",children:!0,parent:!0}});var app=app||{};app.Item=Backbone.Model.extend({defaults:function(){return{input:[],extraction:[],recycling:[],waste:[],output:[]}}});var app=app||{};app.Start=Backbone.Model.extend({defaults:{warningText:"Ce site est compatible avec Firefox, Chrome et Internet Explorer 9+",startTitle:"Métabolisme Urbain de Paris",startText:"Visualisez les flux de matières, d’énergies ou d’eaux et découvrez des projets innovants pour mieux comprendre les interactions de la ville avec son environnement.",z:10,ui_elements:[]}});var app=app||{};app.Router=Backbone.Router.extend({routes:{"":"start",about:"about","t/:id/:type/:time":"territory",p:"projects","p/:category":"projects","p/:category/:id":"project"},initialize:function(a){this.listenTo(Backbone,"route:go",this.go),this.listenTo(Backbone,"route:forceState",this.forceState),this.listenTo(Backbone,"route:buildGo",this.buildGo),this.listenTo(Backbone,"categories:clk",this.updateCategoryState),this.state={rootState:null,categoryState:null,territoryState:null,typeState:null,timeState:null,next:null},this.categoriesData=[{icon:"icon-tous",color:"#9e9e9",label:"Tous les projets",state:"tous_projets"},{icon:"icon-nouveauxmodels",color:"#b4b3b3",label:"Nouveaux modèles économiques",state:"nouveaux_modeles_economiques"},{icon:"icon-eau",color:"#99d2e9",label:"Gestion durable de l'eau",state:"gestion_durable_eau"},{icon:"icon-energies",color:"#fcea27",label:"Récupération et valorisation énergétique",state:"recuperation_valorisation_energetique"},{icon:"icon-matieres",color:"#cbbc9f",label:"Réemploi et réutilisation matières",state:"reemploi_reutilisation_matieres"},{icon:"icon-dechetsverts",color:"#cbbc9f",label:"Valorisation biodéchets et agriculture urbaine",state:"valorisation_biodechets_agriculture_urbaine"},{icon:"icon-chantier",color:"#9cc876",label:"Recyclage et valorisation des déchets de chantier",state:"recyclage_valorisation_dechets_chantier"}];var b={};_.each(this.categoriesData,function(a){b[a.state]=[]}),_.each(a.init,function(a){var c=a.id;if(-1==["paris","pc","projects","idf"].indexOf(c)){var d=a.category,e=[];_.each(d,function(a){e.push(this.categoriesData[a].state)},this),_.each(e,function(a){b[a].push(c)})}},this),this.cat_dict=b,this.previous_state=_.clone(this.state),$(window).on("resize",_.bind(this.reloadView(),this)),_.bindAll(this,"reload")},reloadView:function(){var a,b=this;return function(){clearTimeout(a),a=setTimeout(function(){b.reload()},200)}},forceState:function(a){null!==this.state.rootState&&"p"!==this.state.rootState&&(a.state.rootState&&(this.state.rootState=a.state.rootState),a.state.categoryState&&(this.state.categoryState=null),a.state.territoryState&&(this.state.territoryState=a.state.territoryState),a.state.typeState&&(this.state.typeState=a.state.typeState),a.state.timeState&&(this.state.timeState=a.state.timeState),this.state.categoryState=null,Backbone.trigger("ui:route",{state:this.state}),this.navigate(this.stateToRoute(this.state)))},updateCategoryState:function(a){this.state.categoryState=a.state,this.navigate(this.stateToRoute(this.state))},go:function(a){this.navigate(a,{trigger:!0})},reload:function(a){a&&(this.force_intro=!0),Backbone.history.loadUrl(Backbone.history.fragment)},stateToRoute:function(b){return a=[],_.each(b,function(b){null!==b&&a.push(b)}),a.join("/")},buildGo:function(a){var b=this,c={root:function(a){return"about"!==a.state.rootState?(a.state.rootState=a.id,a.state.territoryState=null,a.state.typeState=null,a.state.timeState=null):a.state=_.clone(a.previous_state),b.stateToRoute(a.state)},territory:function(a){return a.state.rootState="t",a.state.territoryState=a.id,a.state.typeState="paris"===a.id?a.state.typeState||"matter":"matter",a.state.categoryState=null,a.state.timeState=a.state.timeState||1,b.stateToRoute(a.state)},type:function(a){return a.state.rootState=a.state.rootState||"t",a.state.territoryState=a.state.territoryState||"paris",a.state.categoryState=null,a.state.typeState=a.id,a.state.timeState=a.state.timeState||1,b.stateToRoute(a.state)},project:function(a){if(a.state.rootState="p",a.state.territoryState=a.id,a.next){var c=a.previous_state.categoryState,d=a.previous_state.territoryState,e=b.cat_dict[c].indexOf(d);a.state.territoryState=1==a.next?e==b.cat_dict[c].length-1?b.cat_dict[c][0]:b.cat_dict[c][e+1]:0==e?b.cat_dict[c][b.cat_dict[c].length-1]:b.cat_dict[c][e-1]}return a.state.typeState=null,a.state.timeState=null,b.stateToRoute(a.state)},time:function(a){return a.state.rootState=a.state.rootState||"t",a.state.categoryState=null,a.state.territoryState=a.state.territoryState||"paris",a.state.typeState=a.state.typeState||"matter",a.state.timeState="1"===a.state.timeState?"2":"1",b.stateToRoute(a.state)}},d=_.clone(this.state);this.previous_state=d;var e=c[a.change]({state:this.state,previous_state:this.previous_state,id:a.id,next:a.next});this.go(e)},loadView:function(a,b){var c=this,d={start:function(){var a=new app.StartView({model:new app.Start});app.instance.goto(a),c.state.rootState="start",c.state.territoryState=null,c.state.typeState=null,c.state.timeState=null},about:function(){var a=new app.AboutView({model:new app.About});app.instance.goto(a)},projects:function(a){new app.TerritoryView({model:app.instance.territories.territories.get(projects),time:"1",type:"matter","goto":_.bind(app.instance.goto,app.instance),focus_on_project:c.state.territoryState,categoryState:c.state.categoryState});c.state.rootState="p",c.state.categoryState=a.categoryState,c.state.territoryState=null,c.state.typeState=null,c.state.timeState=null},territory:function(a){app.instance.stopListeningPrevious();new app.TerritoryView({model:app.instance.territories.territories.get(a.id),time:a.time,type:a.type,mt:a.mt,intro:a.intro,"goto":_.bind(app.instance.goto,app.instance)});c.state.rootState="t",c.state.territoryState=a.id,c.state.typeState=a.type,c.state.timeState=a.time,c.state.categoryState=null},project:function(a){app.instance.stopListeningPrevious();new app.TerritoryView({model:app.instance.territories.territories.get(a.id),time:1,type:"matter","goto":_.bind(app.instance.goto,app.instance)});c.state.rootState="p",c.state.categoryState=a.categoryState,c.state.territoryState=a.id,c.state.typeState=null,c.state.timeState=null}};d[a](b),Backbone.trigger("ui:route",{state:this.state})},validateRoute:function(a,b){if("territory"===a){var c=["paris","pc","idf"],d=["matter","energy","water"],e=["1","2"];return-1!==_.indexOf(c,b.id)&&-1!==_.indexOf(d,b.type)&&-1!==_.indexOf(e,b.time)}if("project"===a){for(var f=55,g=[],h=[0,7,9,11,14],i=0;f>i;i++)-1==_.indexOf(h,i)&&g.push(i);var j=g.map(function(a){return"p"+a});return this.project_ids=j,console.log(j),-1!==_.indexOf(j,b.id)}},start:function(){this.loadView("start")},about:function(){this.loadView("about")},projects:function(a){null===a&&(a="tous_projets"),args={categoryState:a},this.loadView("projects",args)},category:function(){},territory:function(a,b,c){var d={id:a,type:b,time:c},e=this.previous_state,f=!1,g=!1;if(("start"===this.previous_state.rootState||this.force_intro)&&(this.intro=!0,this.force_intro=!1,g=!0),e&&null!==e.rootState){var h={d_id:d.id===e.territoryState,d_type:d.type===e.typeState,d_t:parseInt(d.time)-parseInt(e.timeState)};if(h.d_id&&h.d_type&&1===Math.abs(h.d_t)){this.state.timeState=d.time;var i="2"===this.state.timeState&&"matter"===this.state.typeState;i?(Backbone.trigger("stories:go",{id:"last"}),Backbone.trigger("ui:route",{state:this.state}),f=!0):(Backbone.trigger("flows:changeYear",{time:d.time,mt:i}),Backbone.trigger("ui:route",{state:this.state}),f=!0)}}if(!f){{var i="2"===c&&"matter"===b;_.extend(d,{mt:i,intro:g})}this.validateRoute("territory",d)&&this.loadView("territory",d),this.state.territoryState=a,this.state.typeState=b,this.state.timeState=c}},project:function(a,b){var c={categoryState:a,id:b};this.validateRoute("project",c)?this.loadView("project",c):this.go("#p/tous_projets")}});var app=app||{};app.Stacks=function(){this.list=[],this.unmessify=function(){for(var a=this.list,b=a.length;b--;){var c=a[b];c.dirty&&c.unmessify()}},this.dirtify=function(){for(var a=this.list,b=a.length;b--;){var c=a[b];c.dirty=!0}}},app.Stack=function(a){this.type=a.type,this.t1=a.t1,this.t2=a.t2,this.flows=[],this.addToStack=function(a){this.flows.push(a),this.dirty=!0},this.dirty=!0},app.Stack.prototype.unmessify=function(){function a(a,b,c){var d=!1,e=a.xfrom,f=a.xto,g=a.yfrom,h=a.yto,i=a.model.get("type");return"input"===i||"output"===i?b.x-.75*c>e&&b.x+.75*c<f&&(d=!0):"waste"===i?b.x-c/2>e&&b.y<h&&(d=!0):"extraction"===i?b.x-c/2<f&&b.y<g&&(d=!0):b.x-c/2<e&&b.x-c/2>f&&(d=!0),d}this.dirty=!1;for(var b=this.flows,c=10;c--;)for(var d=b.length;d--&&!b[d].flowtipview.pos.is_zero;){for(var e=b[d].flowtipview.pos,f=0,g=0,h=0,i=b[d].mid,j=b.length;j--;)if(d!==j&&!b[j].flowtipview.pos.is_zero){var k=b[j].flowtipview.pos,l=(e.w+k.w+25)/2-Math.abs(e.x-k.x),m=(e.h+k.h+50)/2-Math.abs(e.y-k.y),n=l>0&&m>0;if(n){var o=Math.sign(e.x-k.x),p=Math.sign(e.y-k.y);h=2,f+=o*l/h,g+=p*m/h}}var q=b[d].flowtipview.pos.anchor;if(0!==f||0!==g){var r=b[d].flowtipview.pos.x+f/h,s=b[d].flowtipview.pos.y+g/h,t=0,u=b[d].model.get("type");"input"===u||"output"===u?t=Math.sign(f):u&&(t=-Math.sign(f));for(var v=2e3,w=1e3;v>w&&a(b[d],{x:b[d].pulsePath[q].x,y:b[d].pulsePath[q].x},b[d].flowtipview.pos.w);){q+=t,v=w;var x=r-b[d].pulsePath[q].x,y=s-b[d].pulsePath[q].y;w=Math.sqrt(x*x+y*y)}b[d].flowtipview.pos.anchor=q,b[d].flowtipview.pos.x=b[d].pulsePath[q].x-b[d].flowtipview.pos.hc,b[d].flowtipview.pos.y=b[d].pulsePath[q].y-b[d].flowtipview.pos.hc,i=q}0===c&&(b[d].mid=i,b[d].flowtipview.$el.css({top:b[d].pulsePath[q].y-b[d].flowtipview.pos.hc,left:b[d].pulsePath[q].x-b[d].flowtipview.pos.hc}),b[d].midX=b[d].flowtipview.pos.x,b[d].midY=b[d].flowtipview.pos.y)}};var utils=function(){function a(){var a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,b=(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)-10;return{w:a,h:b}}function b(a,b){var c=Raphael.getRGB(a),d=Raphael.rgb2hsl(c.r,c.g,c.b),e=Raphael.hsl(d.h,Math.min(.9*d.s,.8),b);return e}function c(a,b){("string"==typeof a||a instanceof String)&&(a=parseInt(a.replace(/\s+/g,"")));var c=a;c>99&&(c=10*Math.round(a/10));var d=new RegExp("(-?[0-9]+)([0-9]{3})"),e=c+"";for(void 0===b&&(b=",");d.test(e);)e=e.replace(d,"$1"+b+"$2");return e}function d(a,b,c){return a>c?c:b>a?b:a}function e(a,b){if(null==a)return[];if(a.length<2)return a;null==b&&(b=f);var c,d,h;return c=~~(a.length/2),d=e(a.slice(0,c),b),h=e(a.slice(c,a.length),b),g(d,h,b)}function f(a,b){return b>a?-1:a>b?1:0}function g(a,b,c){for(var d=[];a.length&&b.length;)d.push(c(a[0],b[0])<=0?a.shift():b.shift());return a.length&&d.push.apply(d,a),b.length&&d.push.apply(d,b),d}function h(a){return a.toLowerCase().replace(/[èéêë]/g,"e").replace(/[ç]/g,"c").replace(/[àâä]/g,"a").replace(/[ïî]/g,"i").replace(/[ûùü]/g,"u").replace(/[ôöó]/g,"o")}function i(a,b){var c=-1;return function(){clearTimeout(c);var d=arguments,e=this;c=setTimeout(function(){a.apply(e,d)},b)}}return{getWindowSize:a,darkenColor:b,formatVolume:c,constrainNumber:d,mergeSort:e,formatString:h,debounce:i}}();Math.sign=Math.sign||function(a){return isNaN(a)?0/0:0===a?a:a>0?1:-1};var app=app||{};app.AboutView=Backbone.View.extend({id:"about",template:_.template('		<div id = "info_back"></div>  		<div>			<div id = "info_content">				<ul id = "info_header">        			<li><h2>Informations sur cette visualisation</h2></li>        			<li id = "launch"><p>Intro</p></li>        			<li id = "demo"><p>Démo</p></li>      			</ul>      			<ul id = "info_main">      				<li>Les données sur les flux d’énergies et d’eaux sont celles de la Ville de Paris.</li>      				<br>      				<li>La nomenclature des flux et les données utilisées pour cette infographie sont adaptées du rapport de Sabine Barles, professeure d’urbanisme à l’université Paris 1 Panthéon-Sorbonne (UMR Géographie-Cités) : <a href = "data/pdf/Barles-EI-Paris.pdf" target = "_blank">« Mesurer la performance écologique des villes et des territoires : le métabolisme de Paris et de l’Île-de-France »</a></li>      				<br>      				<li>Les tendances relatives à l’évolution des flux de matières ont été évaluées avec l’aide de Laurent Georgeault doctorant de l’université Paris 1 et chargé de mission à l’Institut de l’économie circulaire.</li>    			</ul>    			<p>Pour plus d’information, voir aussi :</p>    			<ul>      				<li class = "refs">BARLES, S. <a href = "http://www.developpementdurable.revues.org/10090" target = "_blank">« L’écologie territoriale et les enjeux de la dématérialisation des sociétés : l’apport de l’analyse des flux de matières »</a>, Développement durable des territoires 5(1), 2014.</li>      				<br>      				<li class = "refs">REPELLIN, P., DURET, B., BARLES, S. <a href = "http://www.statistiques.developpement-durable.gouv.fr/publications/p/2101/1161/comptabilite-flux-matieres-regions-departements-guide.html" target = "_blank">Comptabilité des flux de matières dans les régions et les départements.</a> Guide méthodologique. La Défense : Ministère de l’Écologie, du Développement durable et de l’Énergie – CGDD (coll. « Repères »), 2014.</li>    			</ul>    			<ul id = "credits">      				<li>        				<h3>Maîtrise d’ouvrage :</h3>        				<p>Agence d’écologie urbaine – Mairie de Paris<br>(contact : <a href ="mailto:entreprisesresponsables@paris.fr">entreprisesresponsables@paris.fr</a>)<br></p>        				<a href ="http://www.paris.fr/" target = "_blank"><img src = "./data/graphics/logo-mdp.gif"/></a>      				</li>      				<li>        				<h3>Conception :</h3>        				<p>Elioth<br>(contact : <a href ="mailto:elioth@elioth.fr">elioth@elioth.fr</a>)</p><a href ="http://elioth.com/" target = "_blank"><img src = "./data/graphics/logo-elioth.png"/></a>      				</li>      			</ul>  			</div> 		</div>	'),events:{"click #launch":"intro","click #demo":"demo","mouseover #info_content":"addCircle"},initialize:function(){$("body").addClass("scrollable");var a=Backbone.Collection.extend({model:app.CircleView});this.views_collection=new a},render:function(){return this.$el.html(this.template()),this.$el.addClass("middle"),this.renderRaphael(),this},renderRaphael:function(){var a=this.$el.find("#info_back"),b=utils.getWindowSize(),c=b.w,d=b.h,e=Raphael(a[0],c,d);this.paper=e,this.xleft=.15*c,this.xright=.85*c,this.h=d;var f=Math.floor(500+500*Math.random()),g=Math.floor(250+500*Math.random()),h=this;this.clockAddCircle=setInterval(function(){h.addCircle()},f),this.clockKillCircle=setInterval(function(){h.killCircle()},g)},addCircle:function(){if(this.views_collection.models.length<12){var a=Math.random()>.5?this.xleft:this.xright,b=new app.Circle({cx:a,cy:this.h*(.75*Math.random()+.1)}),c=this.views_collection.add({model:b,paper:this.paper,circles:this.circles});c.render()}},killCircle:function(){if(this.views_collection.models.length>0){var a=Math.floor(this.views_collection.models.length*Math.random()),b=this.views_collection.at(a).close();this.views_collection.remove(b)}},close:function(){this.stopListening(),clearInterval(this.clockAddCircle),clearInterval(this.clockKillCircle),_.each(this.views_collection.models,function(a){a.close(),a.remove()}),this.paper.remove(),this.remove()},transitionIn:function(){this.$el.velocity("fadeIn",{duration:300,complete:callback})},transitionOut:function(a){var b=function(){};a.callback&&(calbback=_.bind(this[a.callback],this)),this.$el.velocity("fadeOut",{duration:300,complete:b})},intro:function(){app.instance.ui.unloadAbout();var a=app.instance.router;console.log(a.state.rootState),"t"!=a.state.rootState?(app.instance.router.force_intro=!0,app.instance.router.go("t/paris/matter/1")):app.instance.router.reload(!0)},demo:function(){Backbone.trigger("ui:demo")}});var app=app||{};app.AppView=Backbone.View.extend({el:"#appcontainer",initialize:function(){this.startZoom=0;var a=this;$.ajax({url:"data/init.json",data:{get_param:"value"},dataType:"json",success:function(b){a.ui=new app.UIView(a,{init:b.ui}),a.territories=new app.TerritoriesView({init:b.navigation}),this.router=new app.Router({init:b.navigation}),Backbone.history.start()}})},"goto":function(a){function b(a){return function(){a.close(),a.remove(),delete a}}var c=this.currentPage||null,d=a;c&&c.stopAllListening();var e=!c||_.isUndefined(c.model.get("z"))||_.isUndefined(d.model.get("z"))?0:c.model.get("z")-d.model.get("z");d.render({dz:e}),this.$el.append(d.$el),this.currentPage=d,c?_.delay(function(){c.transitionOut({dz:e,callback:b(c)}),d.transitionIn({dz:e})},400):_.delay(function(){d.transitionIn({dz:e})},400);this.ui.showButtons(d,800)},stopListeningPrevious:function(){this.currentPage&&(this.currentPage.stopListening(),this.currentPage.items_views&&(this.currentPage.items_views.stopListening(),this.currentPage.flows_views.stopListening(),this.currentPage.stories_views.stopListening()),this.projects_views&&this.currentPage.projects_views.stopListening())}});var app=app||{};app.ButtonView=Backbone.View.extend({events:{click:"clk",mouseover:"over",mouseout:"out"},initialize:function(){var a=this.model.toJSON();if(this.bang=a.bang,this.grey=a.grey,this.clicked=!1,this.radio=a.radio?!0:!1,this.$el.css({"background-color":a["bg-col-n"]}),a.geometry){var b=this.$el.width(),c=this.$el.height(),d=Raphael(this.el,b,c),e=d.add(a.geometry),f=Math.min(b/a.width,b/a.height)*a.scale;e.transform(["...T",b/2-a.width/2,b/2-a.height/2]),e.transform(["...S",f,f,b/2,b/2]),this.grey&&this.storeGreys(e)}},close:function(){},clk:function(a){if(!this.bang){if(this.clicked=!0,this.$el.css({"background-color":this.model.get("bg-col-a")}),this.$el.addClass("button-clicked"),this.grey)for(var b=this.items.length;b--;)this.items[b].attr({fill:this.e_colors[b]}),this.items[b].attr({stroke:this.strokes[b]});this.radio&&Backbone.trigger("ui:clickRadio",{id:this.model.get("id")})}!a.silent&&this.model.get("change")&&Backbone.trigger("route:buildGo",{change:this.model.get("change"),id:this.model.get("id"),next:this.model.get("next")})},unclick:function(){if(this.clicked=!1,this.$el.css({"background-color":this.model.get("bg-col-n")}),this.$el.removeClass("button-clicked"),this.grey)for(var a=this.items.length;a--;)this.items[a].attr({fill:this.grey_colors[a]}),this.items[a].attr({stroke:this.grey_strokes[a]})},over:function(){this.$el.css({"background-color":this.model.get("bg-col-a")})},out:function(){!this.clicked&&this.$el.css({"background-color":this.model.get("bg-col-n")})},storeGreys:function(a){function b(a,b){var c=Raphael.getRGB(a),d=Raphael.rgb2hsl(c.r,c.g,c.b),e=Raphael.hsl(d.h,d.s*b,d.l);return e}this.items=a.items;for(var c=[],d=[],e=[],f=[],g=a.items,h=g.length,i=0;h>i;i++){var j=g[i].attr("fill"),k=g[i].attr("stroke");c.push(j),e.push(k),d.push(b(j,0)),f.push(b(k,0)),g[i].attr({fill:b(j,0)}),g[i].attr({stroke:b(k,0)})}this.e_colors=c,this.strokes=e,this.grey_colors=d,this.grey_strokes=f}});var app=app||{};app.CategoryView=Backbone.View.extend({tagName:"li",className:"categorybutton",events:{mouseenter:"over",mouseleave:"out",click:"clk"},template:_.template("<span></span>"),initialize:function(a){a.clicked&&(this.over(),this.clk({silent:!0}))},render:function(){return this.renderContent().cacheComponents(),this},cacheComponents:function(){return this},renderContent:function(){var a=this;return this.$el.html(this.template(this.model.attributes)),this.$el.css({"border-bottom-color":this.model.color}),this.$el.find("span").addClass(a.model.icon),this},over:function(){this.$el.addClass("category-over"),Backbone.trigger("categories:focus",{label:this.model.label})},out:function(){!this.clicked&&this.$el.removeClass("category-over"),Backbone.trigger("categories:unfocus")},clk:function(a){this.clicked=!0,Backbone.trigger("categories:clk",{id:this.id,label:this.model.label,state:this.model.state,options:a})},unclk:function(){this.clicked=!1,this.$el.removeClass("category-over")},close:function(){this.stopListening()}});var app=app||{};app.CircleView=Backbone.View.extend({template:_.template('<div class = "pulse"></div></div>'),initialize:function(a){this.paper=a.paper},cacheComponents:function(){return this.$pulse=this.$el.find(".pulse"),this},render:function(){var a=this.model.toJSON(),b=this.paper.path();b.attr({path:["M",a.x,a.y-a.rad,"A",a.rad,a.rad,0,1,1,a.x-.1,a.y-a.rad,"Z"],stroke:a.col,"stroke-width":a.sw,opacity:a.op}),b.toBack(),this.path=b,this.transitionIn()},transitionIn:function(){var a=this.model.toJSON();this.path.animate({transform:["s",4,4,a.x,a.y],"stroke-width":a.sw},400+Math.round(400*Math.random()),"elastic")},transitionOut:function(){},close:function(){var a=function(){this.path.remove(),this.stopListening()},b=this.model.toJSON(),c=500+Math.floor(500*Math.random());return this.path.animate({transform:["s",.5,.5,b.x,b.y]},c,"ease-in",_.bind(a,this)),this},renderPulse:function(){function a(){$.Velocity.RunSequence(i)}function b(a){for(var b=a.element,c=a.path,d=[],e=a.increment,f=c.length,g=a.duration/f*e,h=0;f>h;h+=e){var i=Math.round(10*c[h].y)/10,j=Math.round(10*c[h].x)/10,k={duration:g,easing:"linear"};0===h?k={duration:0,easing:"linear"}:h>f-e-1&&(k={duration:g,easing:"linear",complete:a.complete});var l={elements:b,properties:{top:i,left:j},options:k};d.push(l)}return d}for(var c=this.pupath,d=[],e=10,f=(c.getTotalLength(),0);f<c.getTotalLength();){var g=c.getPointAtLength(f);d.push({x:g.x,y:g.y}),f+=e}this.pulsePath=d,this.pupath.remove();var h=this.model.get("sw");offset=-Math.round(h/2),this.$pulse.css({width:h,height:h,"margin-top":offset,"margin-left":offset,"background-color":"#fff",opacity:.2}),this.pulsing&&this.$pulse.velocity("stop",!0);var i=b({element:this.$pulse,path:d,duration:40*d.length,increment:5,complete:a});return $.Velocity.RunSequence(i),this.pulsing=!0,this}});var app=app||{};app.DemoView=Backbone.View.extend({id:"video_container",template:_.template('		<div id="close_demo">    		<span>X</span>  		</div>  		<div class="wrapper hidden">    		<video controls id="offline_video">      			<source src="data/video/demo.mp4"></source>   			</video>  		</div>  		<iframe id = "video"          class = ""          src="//www.youtube.com/embed/35oqKJgJbaE"          frameborder="0"          allowfullscreen>  		</iframe>	'),events:{"click #close_demo":"UIclose"},initialize:function(){},render:function(){return this.$el.html(this.template()),this.$el.addClass("middle"),this},close:function(){this.stopListening()},UIclose:function(){Backbone.trigger("ui:closeDemo")}});var app=app||{};app.FlowView=Backbone.View.extend({className:"flow",template:_.template('<div class = "pulse"></div></div>'),initialize:function(a){_.bindAll(this,"close"),this.ito=a.ito,this.ifrom=a.ifrom,this.parent=a.parent,this.$popcontainer=this.parent.$popcontainer,this.$flowcontainer=this.parent.$flowcontainer,this.flowtip=new app.FlowTip,this.flowtipview=new app.FlowTipView({model:this.flowtip,parent:this}),this.rendered=!1},cacheComponents:function(){return this.$pulse=this.$el.find(".pulse"),this},close:function(){this.$pulse.velocity("stop",!0),this.flowtipview.close(),this.flowtipview.remove(),this.stack.flows=_.filter(this.stack.flows,function(a){return a.id!==this.id},this);var a=this;this.path.animate({"stroke-width":0},200,a.path.remove),this.stopListening()},render:function(a){return this.renderContent().cacheComponents().renderPath().animatePath(a.animate).renderPulse().findRealMid().renderFlowTip(a.year,a.mt),this},updateRender:function(a){return this.renderPath().animatePath(a.animate).renderPulse().findRealMid().renderFlowTip(a.year,a.mt),this},renderContent:function(){this.$el.html(this.template());var a=$(window).width(),b=$(window).height();return this.paper=Raphael(this.$el[0],a,b),this},renderPath:function(){var a=this.model.get("type"),b=this.ifrom,c=this.ito,d=b.fax,e=b.fay,f=c.fax,g=c.fay,h=b.w||0,i=b.h||0,j=c.w||0,k=(c.h||0,this.model.get("offsetto")||0),l=this.model.get("offsetfrom")||0,m=this.model.get("offsetextr")||0,n=(this.model.get("offsetwast")||0,d+h/2);yfrom=e+l,xto=f-j/2,yto=g+k,this.xfrom=n,this.xto=xto,this.yfrom=yfrom,this.yto=yto;var o=Math.abs(xto-n)/2+Math.sign(e-g)*l,p=Math.abs(xto-n)/2-Math.sign(e-g)*k,q=Math.abs(xto-n),r=Math.abs(yto-yfrom),s=(n+xto)/2,t=(yfrom+yto)/2;this.midX=s,this.midY=t;var u=[];if("extraction"===a?u.push(["M",d-.15*b.w+m,e]):(u.push(["M",d,yfrom]),u.push(["L",n,yfrom])),"input"===a||"output"===a)if(.9*xto>n){var v={x:n+o,y:yfrom},w={x:xto-p,y:yto},x=["C",v.x,v.y,w.x,w.y,xto,yto];u.push(x)}else{var y=0,z=0;n>xto&&(y=(q+r)/6,z=1);var v={x:n+(q+r)/h*30,y:yfrom},w={x:s+q/2,y:t+r/2+y},A={x:s,y:t+z*r/2+y},B={x:s-q/2,y:t+r/2+y},C={x:xto-(q+r)/h*30,y:yto},D=["C",v.x,v.y,w.x,w.y,A.x,A.y],E=["C",B.x,B.y,C.x,C.y,xto,yto];u.push(D,E)}else if("recyclage"===a){this.offsetrecy=-this.model.get("offsetrecy");var F=h/4+2*this.offsetrecy+100;F=F>100?100+3*this.offsetrecy:F-this.offsetrecy;var G=+h/2+5*this.offsetrecy+100;G=G>300?300+3*this.offsetrecy:G-this.offsetrecy,u.push(["C",n+F,yfrom,d+G,e+i/1+1.25*this.offsetrecy,d,e+i/1+1.25*this.offsetrecy]),u.push(["C",d-G,e+i/1+1.25*this.offsetrecy,xto-F,yto,xto,yto])}else if("extraction"===a){var H=this.model.get("offsetextr");u.push(["C",d+H,e-1.5*i-4*H,xto-h/4-4*H,yto,xto,yto])}else{var H=this.model.get("offsetwast");u.push(["C",n+(i+h)/4+4*H,yfrom,d+.15*b.w,yto-(i+h)/2-5*H,d+.15*b.w-H,yto])}u.push(["L",f,yto]);var I=_.extend(this.model.attributes.geometry,{path:u,stroke:this.model.get("n_color")}),J=[];return J.push(I),this.flowpath=this.paper.path(u).hide(),this.path||(this.path=this.paper.add(J).items[0]),this},findRealMid:function(){if("input"===this.model.get("type")||"output"===this.model.get("type")){for(var a=(this.xfrom+this.xto)/2,b=this.midY,c=Math.floor(this.pulsePath.length/3),d=2e3,e=1e3;d>e;){c++,d=e;var f=a-this.pulsePath[c].x,g=b-this.pulsePath[c].y;e=Math.sqrt(f*f+g*g)}this.mid=c,this.midX=this.pulsePath[c].x,this.midY=this.pulsePath[c].y}else this.mid=Math.floor(this.pulsePath.length/2),this.midX=this.pulsePath[this.mid].x,this.midY=this.pulsePath[this.mid].y;return this},animatePath:function(a,b){var c=this.model.get("volume");return"appear"===a?(this.path.attr({"stroke-width":0}),this.path.animate({"stroke-width":c},500,"backOut")):(this.path.animate({path:this.flowpath.attr("path")},200),this.path.animate({"stroke-width":c},200,"linear",b)),this},renderPulse:function(){function a(){$.Velocity.RunSequence(i)}function b(a){for(var b=a.element,c=a.path,d=[],e=a.increment,f=c.length,g=a.duration/f*e,h=0;f>h;h+=e){var i=Math.round(10*c[h].y)/10,j=Math.round(10*c[h].x)/10,k={duration:g,easing:"linear"};0===h?k={duration:0,easing:"linear"}:h>f-e-1&&(k={duration:g,easing:"linear",complete:a.complete});var l={elements:b,properties:{top:i,left:j},options:k};d.push(l)}return d}for(var c=this.flowpath,d=[],e=5,f=(c.getTotalLength(),0);f<c.getTotalLength();){var g=c.getPointAtLength(f);d.push({x:g.x,y:g.y}),f+=e}this.pulsePath=d,this.flowpath.remove();var h=this.model.get("volume");offset=-Math.round(h/2),this.$pulse.css({width:h,height:h,"margin-top":offset,"margin-left":offset,"background-color":"#fff",opacity:.2}),this.pulsing&&this.$pulse.velocity("stop",!0);var i=b({element:this.$pulse,path:d,duration:20*d.length,increment:5,complete:a});return $.Velocity.RunSequence(i),this.pulsing=!0,this},renderFlowTip:function(a,b){return this.flowtipview.rendered?this.flowtipview.updateRender({year:a,mt:b}):this.$popcontainer.append(this.flowtipview.render({year:a,mt:b}).el),this},renderClean:function(){return this.flowtipview.attachButtons(),this.flowtipview.correctPosition(),this},over:function(){this.path.attr({stroke:this.model.get("a_color")})},out:function(){this.path.attr({stroke:this.model.get("n_color")})},changeYear:function(){}});var app=app||{};app.FlowsView=Backbone.View.extend({initialize:function(a){this.parent=a.parent,this.items_views=a.items_views;var b=Backbone.Collection.extend({model:app.FlowView});this.views_collection=new b,this.stacks=new app.Stacks,this.listenTo(Backbone,"flows:children",this.loadChildren),this.listenTo(Backbone,"flows:parent",this.loadParent),this.listenTo(Backbone,"flows:changeYear",this.changeYear),this.listenTo(Backbone,"flows:nav",this.nav),this.listenTo(Backbone,"flows:expand",this.expand),this.listenTo(Backbone,"flows:contract",this.contract)},render:function(a){var b="same"===a.time?this.time:a.time;this.time=b;var c=this.items_views.views_collection,d=_.filter(this.collection.models,function(b){return _.indexOf(a.view_list,b.id)>-1}),e=[];if("all"===a.hide_list){var f=this.views_collection.models;_.each(f,function(a){e.push(a.model)})}else e=_.filter(this.collection.models,function(b){return _.indexOf(a.hide_list,b.id)>-1});this.unloadFlows(e),this.loadFlows(d);var g=d[0]||e[0],h=a.scaling?!0:!1;return this.scale=h?this.findScale({unit:g&&g.get("unit")||"",virtual:g&&g.get("virtual")||!1}):this.scale,this.scaleFlows({time:b,target_flows:d,scale:this.scale}),this.offsetFlows({target_flows:d,ref_from:a.ref_from,ref_to:a.ref_to,ref_recy:a.ref_recy,ref_extr:a.ref_extr,ref_wast:a.ref_wast}),_.each(d,function(d){if(this.views_collection.get(d.get("id")))this.views_collection.get(d.get("id")).flowtipview.out(),this.views_collection.get(d.get("id")).updateRender({year:b,animate:"changeYear",mt:a.mt});else{var e=d.get("from"),f=d.get("to"),g=this.views_collection.add({model:d,id:d.get("id"),ifrom:c.get(e),ito:c.get(f),parent:this.parent}),h=this.stacks.list,i=h.length;if(0===i){var j=new app.Stack({type:d.get("type"),t1:e,t2:f});j.addToStack(g),this.stacks.list.push(j),g.stack=j}else for(;i--;){if(!(h[i].type!==d.get("type")||h[i].t1!==e&&h[i].t2!==e||h[i].t1!==f&&h[i].t2!==f)){h[i].addToStack(g),g.stack=h[i];break}if(0===i){var j=new app.Stack({type:d.get("type"),t1:e,t2:f});j.addToStack(g),this.stacks.list.push(j),g.stack=j}}this.parent.$flowcontainer.prepend(g.render({year:b,animate:"appear",mt:a.mt}).el),g.renderClean()}},this),this.stacks.dirtify(),this.stacks.unmessify(),this.stackFlowTips(),a.popups&&_.each(a.popups,function(a){this.views_collection.get(a).flowtipview.over(),this.views_collection.get(a).flowtipview.clickDot()},this),this},loadFlows:function(a){var b=this.items_views.views_collection;_.each(a,function(a){if(!this.views_collection.get(a.get("id"))){{var c=a.get("from"),d=a.get("to");a.get("id")}"extraction"!==a.get("type")&&b.get(c).output.add(a),"waste"!==a.get("type")&&b.get(d).input.add(a),"recyclage"===a.get("type")&&b.get(c).recyclage.add(a),"extraction"===a.get("type")&&b.get(c).extraction.add(a),"waste"===a.get("type")&&b.get(c).waste.add(a)
}},this)},unloadFlows:function(a){var b=this.items_views.views_collection,c=this;_.each(a,function(a){var d=a.get("from"),e=a.get("to"),f=a.get("id");"extraction"!==a.get("type")&&b.get(e).input.remove(f),"waste"!==a.get("type")&&b.get(d).output.remove(f),"recyclage"===a.get("type")&&b.get(d).recyclage.remove(f),"extraction"===a.get("type")&&b.get(d).extraction.remove(f),"waste"===a.get("type")&&b.get(d).waste.remove(f),c.views_collection.get(f).close(),_.delay(function(){c.views_collection.get(f).remove(),c.views_collection.remove(f)},300)})},close:function(){_.each(this.views_collection.models,function(a){a.close()}),this.stopListening()},findScale:function(a){var b=0,c=1e4,d=0;_.each(this.items_views.views_collection.models,function(a){var e=a.id;if("t0"!==e&&"t1"!==e){var f=a.input.models,g=a.output.models,h=0,i=0,j=0,k=0;_.each(f,function(a){h+=parseInt(a.get("volume_o4")),j+=parseInt(a.get("volume_o9"))}),_.each(g,function(a){i+=parseInt(a.get("volume_o4")),k+=parseInt(a.get("volume_o9"))}),b=Math.max(b,h,i,j,k),c=a.h<c?a.h:c,a.model.get("ref")&&(d=a.h)}});var e=Math.max(2,b),f=.95*(d||c),g=Math.round(1e4*f/e)/1e4;return Backbone.trigger("ui:scale",{scale:g,unit:a.unit,virtual:a.virtual}),g},scaleFlows:function(a){var b="1"===String(a.time)?"volume_o4":"volume_o9";_.each(a.target_flows,function(c){var d=c.get(b)*a.scale;c.set("is_zero",!1),0===d?(d=0,c.set("is_zero",!0)):2>d&&(d=2),c.set("volume",Math.round(10*d)/10)})},offsetFlows:function(a){var b=[];_.each(a.target_flows,function(a){b.push(a.id)});var c=this;_.each(this.items_views.views_collection.models,function(d){function e(a){var d=a.type,e="offsetto";"output"===d?e="offsetfrom":"recyclage"===d?e="offsetrecy":"extraction"===d?e="offsetextr":"waste"===d&&(e="offsetwast");var f=a.item[d].models;f=_.filter(f,function(a){return _.indexOf(b,a.id)>-1}),f=utils.mergeSort(f,_.bind(c.idSort,c)),f=utils.mergeSort(f,_.bind(c.volumeSort,c));var g=0,h=[];_.each(f,function(a){var b=a.get("volume");h.push(g+b/2),g+=b});var i=a.ref?a.ref:0;_.each(f,function(a,b){a.set(e,h[b]-g/2+i)})}d.id;e({item:d,type:"input",ref:a.ref_to}),e({item:d,type:"output",ref:a.ref_from}),e({item:d,type:"recyclage",ref:a.ref_recy}),e({item:d,type:"extraction",ref:a.ref_extr}),e({item:d,type:"waste",ref:a.ref_wast})})},idSort:function(a,b){var c=parseInt(a.get("id")),d=parseInt(b.get("id")),e=c>d;return e},volumeSort:function(a,b){var c=parseInt(a.get("volume")),d=parseInt(b.get("volume")),e=this.areSiblings(a,b),f=e?c>d:0;return f},masterInputSort:function(a,b){var c=a.get("type"),d=b.get("type"),e=parseInt(a.get("id")),f=parseInt(b.get("id")),g=a.get("volume"),h=b.get("volume"),i=this.areSiblings(a,b),j=0;return j=c===d&&i?h>g:"extraction"===c&&"input"===d?-1:"recyclage"===c&&"input"===d?1:"input"===c&&"extraction"===d?1:"input"===c&&"recyclage"===d?1:+(f>e)},masterOutputSort:function(a,b){var c=a.get("type"),d=b.get("type"),e=parseInt(a.get("id")),f=parseInt(b.get("id")),g=a.get("volume"),h=b.get("volume"),i=this.areSiblings(a,b);return r=c===d&&i?h>g:"waste"!==c||"output"!==d&&"input"!==d?"waste"!==d||"output"!==c&&"input"!==c?"recyclage"===c&&"output"===d?1:"output"!==c&&"input"!==c||"waste"!==d?"output"===c&&"recyclage"===d?-1:"recyclage"===c&&"waste"===d?-1:"waste"===c&&"recyclage"===d?-1:e>f:-1:1:-1},volumeSort:function(a,b){var c=this.areSiblings(a,b);if(c){var d=-a.get("volume")+b.get("volume");return d}return parseInt(a.get("id"))-parseInt(b.get("id"))},areSiblings:function(a,b){var c=a.get("siblings"),d=b.get("siblings");if(c&&d){for(var e=!1,f=c.length;f--;)if(c[f]===b.get("id")){e=!0;break}return e}return!1},stackFlowTips:function(){function a(a,b){return a.midY-b.midY}var b=this.views_collection.models;b.sort(a);for(var c=b.length;c--;)this.views_collection.get(b[c].id).flowtipview.zOrder(c+100)},loadChildren:function(a){var b=this.collection.get(a.parentid),c=b.get("children"),d=_.filter(this.collection.models,function(a){return _.indexOf(c,a.id)>-1}),e=!0;if(_.each(d,function(a){(-1===a.get("volume_o4")||-1===a.get("volume_o9"))&&(e=!1)}),e){var f=b.get("offsetfrom"),g=b.get("offsetto"),h=b.get("offsetrecy"),i=b.get("offsetextr"),j=b.get("offsetwast");this.render({view_list:a.ids,hide_list:[a.parentid],time:"same",ref_from:f,ref_to:g,ref_recy:h,ref_extr:i,ref_wast:j})}},nav:function(a){var b=[];"all"===a.hl[0]?_.each(this.views_collection.models,function(c){_.indexOf(a.vl,c.id)<0&&b.push(c.id)}):b=a.hl,this.render({view_list:a.vl,hide_list:b,time:a.time,popups:a.popups,scaling:a.scaling,mt:a.mt})},loadParent:function(a){var b=this,c=this.collection.get(a.parentid),d=c.get("offsetfrom"),e=c.get("offsetto"),f=c.get("offsetrecy"),g=c.get("offsetextr"),h=c.get("offsetwast"),i=[],j=c.get("level"),k=c.get("type"),l=c.get("children");"undefined"==typeof d&&(d=0,e=0,f=0,g=0,h=0,_.each(l,function(a){var c=b.collection.get(a);d+=c.get("offsetfrom"),e+=c.get("offsetto"),f+=c.get("offsetrecy"),g+=c.get("offsetextr"),h+=c.get("offsetwast")}),n=l.length,d/=n,e/=n,f/=n,g/=n,h/=n);_.each(this.views_collection.models,function(a){(a.model.get("type")===k&&-1!==_.indexOf(l,a.model.get("id"))||a.model.get("level")===j+2)&&i.push(a.id)}),this.render({view_list:[a.parentid],hide_list:i,time:"same",ref_from:d,ref_to:e,ref_recy:f,ref_extr:g,ref_wast:h})},changeYear:function(a){var b=[];_.each(this.views_collection.models,function(a){b.push(a.id)}),this.render({view_list:b,hide_list:[],time:a.time,mt:a.mt})},expand:function(a){var b=[],c=[];_.each(this.collection.models,function(c){c.get("leaf")&&c.get("nature")===a.type&&b.push(c.id)}),_.each(this.views_collection.models,function(a){_.indexOf(b,a.id)<0&&c.push(a.id)}),this.render({view_list:b,hide_list:c,time:"same"})},contract:function(a){var b=[],c=[];_.each(this.collection.models,function(c){c.get("root")&&c.get("nature")===a.type&&b.push(c.id)}),_.each(this.views_collection.models,function(a){_.indexOf(b,a.id)<0&&c.push(a.id)}),this.render({view_list:b,hide_list:c,time:"same"})}});var app=app||{};app.FlowTipView=Backbone.View.extend({className:"flowtip",template:_.template('		<div class = "pulse"></div>      	<div class = "dot"></div>      	<div class = "mousebox"></div>      	<div class = "tip border-tip">        	<h3><%= name %></h3>        	<ul class = "label">          		<li><p class = "volume"></p> <p class = "unit"><%= unit %></p></li>          		<li id = "ungroup" class = "popbutton"><span>Détail du flux</span></li>          		<li id = "group" class = "popbutton"><span>Retour en arrière</span></li>        	</ul>        	<b class="border-notch notch"></b>        	<b class="notch"></b>    	</div>	'),events:{mouseover:"over",mouseout:"out",click:"clickDot","click #group":"group","click #ungroup":"ungroup"},initialize:function(a){this.parent=a.parent,this.content=_.pick(this.parent.model.attributes,"name","volume","unit","children","parent"),this.focus_color=utils.darkenColor(this.parent.model.get("a_color"),.55),this.rendered=!1,this.pos={is_zero:this.parent.model.get("is_zero")}},close:function(){this.group_b&&this.group_b.remove(),this.ungroup_b&&this.ungroup_b.remove(),this.$trend&&this.$trend.velocity("stop"),this.stopListening()},cacheComponents:function(){return this.$tip=this.$el.find(".tip"),this.$dot=this.$el.find(".dot"),this.$group=this.$el.find("#group"),this.$ungroup=this.$el.find("#ungroup"),this.$labels=this.$el.find("span"),this.$volume=this.$el.find(".volume"),this.$unit=this.$el.find(".unit"),this.$label=this.$el.find(".label"),this},render:function(a){return this.renderContent().cacheComponents().renderVolume(a.year).renderUnit().styleComponents().renderPosition().renderBase().renderTrend(a.mt),this.rendered=!0,this},updateRender:function(a){return this.renderContent().renderVolume(a.year).renderBase().correctPosition().renderTrend(a.mt),this},renderPosition:function(){var a=this.parent.mid,b="extraction"===this.parent.model.get("type")||"waste"===this.parent.model.get("type")?15:5,c=Math.floor(b*(Math.random()-.5)),d=this.parent.pulsePath;len=d.length,a+=c,x=d[a+c].x,y=d[a+c].y;var e=this.parent.model.get("volume"),f=.6*utils.constrainNumber(e,20,60);return this.vol_c=f,this.pos.anchor=a,this.pos.x=x,this.pos.y=y,this.pos.hc=f/2,this.$el.css({top:y-f/2,left:x-f/2}),this},renderContent:function(){if(!this.rendered&&(this.$el.html(this.template(this.content)),"matter"===this.parent.model.get("nature"))){var a=parseInt(this.parent.model.get("trend")),b="";0===a?b='<div id = "trend" class = "hidden"><div id = "tr1" class = "trend flat"></div></div>':1===a?b='<div id = "trend" class = "hidden"><div id = "tr1" class = "trend plus"></div></div>':2===a?b='<div id = "trend" class = "hidden"><div id = "tr1" class = "trend plus"></div><div id = "tr2" class = "trend plus"></div></div>':-1===a?b='<div id = "trend" class = "hidden"><div id = "tr1" class = "trend minus"></div></div>':-2===a&&(b='<div id = "trend" class = "hidden"><div id = "tr1" class = "trend minus"></div><div id = "tr2" class = "trend minus"></div></div>'),this.$trend=$(b).appendTo(this.$el)}return this},renderVolume:function(a){var b="1"===String(a)?"volume_o4":"volume_o9";if(this.parent.model.get("virtual")||-1===this.parent.model.get(b))this.$volume.addClass("hidden");else{var c=utils.formatVolume(this.parent.model.get(b)," ");this.$volume.html(c)}return this},renderUnit:function(){return this.parent.model.get("virtual")&&-1!==this.parent.model.get("volume")&&this.$label.addClass("hidden"),this},attachButtons:function(){this.content.parent&&(this.group_b=new app.ButtonView({model:app.instance.ui.b_collection.get("group"),el:this.$group})),this.content.children&&(this.ungroup_b=new app.ButtonView({model:app.instance.ui.b_collection.get("ungroup"),el:this.$ungroup})),!this.content.parent&&this.$group.css({display:"none"}),!this.content.children&&this.$ungroup.css({display:"none"})},renderBase:function(){var a=this.vol_c;return this.rendered?this.$el.velocity({width:a,height:a},{duration:200}):this.$el.css({width:a,height:a}),this.$el.css(this.parent.model.get("is_zero")?{display:"none"}:{display:"inline-block"}),this},correctPosition:function(){var a=this.$tip.width(),b=this.$tip.height(),c=this.vol_c;return this.$tip.css({top:-b+.25*c-25,left:.5*-a+c/2-10}),this.$dot.css({top:c/2-4,left:c/2-4}),this.$labels.css({"margin-top":-b-5}),this.$trend&&this.$trend.css({top:c/2-10,left:c/2-4+10}),this.pos.w=a,this.pos.h=b,this},styleComponents:function(){return this.$el.css({"background-color":this.parent.model.get("a_color")}),!this.parent.model.get("children")&&this.$dot.css({"background-color":this.parent.model.get("n_color")}),this},renderTrend:function(a){if(this.$trend){var b=this,c=this.$trend,d=this.$label,e=[];a?(e.push({elements:this.$el,properties:{opacity:0},options:{duration:100,complete:function(){d.addClass("hidden"),b.correctPosition()}}}),e.push({elements:this.$el,properties:{opacity:1},options:{duration:100,complete:function(){c.addClass("show_v")}}}),e.push({elements:this.$trend,properties:{top:"+=10"},options:{loop:!0}})):(e.push({elements:this.$el,properties:{opacity:0},options:{duration:100,complete:function(){c.velocity("stop").velocity("reverse"),c.removeClass("show_v"),d.removeClass("hidden"),b.correctPosition()}}}),e.push({elements:this.$el,properties:{opacity:1},options:{duration:100}})),$.Velocity.RunSequence(e)}},zOrder:function(a){this.$el.css({"z-index":a})},over:function(){this.$el.css({"background-color":this.focus_color}),this.$tip.addClass("tip-displayed"),this.parent.over()},out:function(){this.$el.css({"background-color":this.parent.model.get("a_color")}),this.$tip.removeClass("tip-displayed"),this.parent.out()},clickDot:function(){this.clicked?(this.delegateEvents(),this.clicked=!1):(this.$el.off("mouseover mouseout"),this.clicked=!0)},group:function(){Backbone.trigger("flows:parent",{parentid:this.parent.model.get("parent")})},ungroup:function(){Backbone.trigger("flows:children",{ids:this.parent.model.get("children"),parentid:this.parent.model.get("id")})}});var app=app||{};app.IntroView=Backbone.View.extend({id:"intro",events:{click:"close"},template:_.template('		<div id = "intro_back"></div>    	<div id = "top_left" class = "intro_box"><p><div class = "arrow-up"></div><%=topleft%></p></div>    	<div id = "top_right1" class = "intro_box"><div class = "arrow-right"></div><p><%=topright1%></p></div>    	<div id = "top_right2" class = "intro_box"><div class = "arrow-right"></div><p><%=topright2%></p></div>    	<div id = "top_right3" class = "intro_box"><div class = "arrow-right"></div><p><%=topright3%></p></div>    	<div id = "bottom" class = "intro_box"><div class = "arrow-down"></div><p><%=bottom%></p></div>	'),initialize:function(){_.bindAll(this,"resizeBack"),this.content={topleft:"Trois types de flux : matières, énergies, eaux",topright1:"Accès aux projets innovants",topright2:"<br>Trois échelles : Paris, Ile-de-France, Petite Couronne<br><br> ",topright3:"Les tendances d'évolution",bottom:"Les informations complémentaires sur les flux"}},render:function(){return this.renderContent().cacheComponents().attachResize(),this},renderContent:function(){return this.$el.html(this.template(this.content)),this},cacheComponents:function(){return this.$back=this.$el.find("#intro_back"),this.$bottom=this.$el.find("#bottom"),this},resizeBack:function(){var a=$(window),b=a.innerWidth(),c=a.innerHeight();this.$back.css({width:.97*b+"px",height:.95*c+"px",top:.025*c,left:.015*b})},attachResize:function(){var a=$(window),b=a.innerWidth(),c=a.innerHeight();return this.$back.css({width:.97*b+"px",height:.95*c+"px",top:.025*c,left:.015*b}),$(window).on("resize",this.resizeBack),this},close:function(){this.stopListening(),$(window).off("resize",this.resizeBack),this.remove()}});var app=app||{};app.ItemView=Backbone.View.extend({className:"item",template:_.template('<p class = "label hidden"></p>'),initialize:function(a){this.listenTo(Backbone,"items:updatePositions",this.updatePositions),this.parent=a.parent;var b=Backbone.Collection.extend({model:app.Flow});this.input=new b,this.output=new b,this.recyclage=new b,this.extraction=new b,this.waste=new b;var c=this,d=this.model.get("geom");d?$.ajax({url:d,data:{get_param:"value"},dataType:"json",success:function(a){c.model.set(a),_.bind(c.createCanvas,c)(a),c.parent.parent.$itemcontainer.children(":first").prepend(c.render().el)},complete:function(){a.complete()}}):(c.parent.parent.$itemcontainer.children(":first").prepend(c.render().el),a.complete())},updatePositions:function(a){var b=/[+-]?\d+(\.\d+)?/g,c=a.mat.match(b).map(function(a){return parseFloat(a)});this.w=this.wBase*c[0],this.h=this.hBase*c[0],ws=a.ws;var d=this.parent.parent.projects_views.previous_zoom,e=parseFloat($("#rightpanel").css("left")),f=this.X-ws.clientX+e,g=f*c[0]/d,h=g+ws.clientX-e,i=parseFloat($("#rightpanel").css("top")),j=this.Y-ws.clientY+i,k=j*c[0]/d,l=k+ws.clientY-i;this.X=h,this.Y=l},createCanvas:function(a){var b=utils.getWindowSize(),c=b.w,d=b.h,e=Math.sqrt(c/a.width*this.model.get("scale")),f=Math.sqrt(d/a.height*this.model.get("scale")),g=this.model.get("force_w_scale")?e:Math.min(e,f),h=a.width*g*g,i=a.height*g*g;this.r=Raphael(this.$el[0],h,i),$("svg",this.$el).css({position:"absolute"}),this.scaling=g,this.w=h*parseFloat(this.model.get("iw")),this.h=i*parseFloat(this.model.get("ih")),this.wBase=this.w,this.hBase=this.h,this.model.set("w_mod",h),this.model.set("h_mod",i)},render:function(){return this.renderContent().cacheComponents().renderGeometry().renderSolution().renderTip(),this},renderContent:function(){return this.$el.css("z-index",this.model.get("z")),this.$el.append(this.template()),this},cacheComponents:function(){return this.$label=this.$el.find(".label"),this},renderGeometry:function(){var r=this.r,m=this.model,scaling=this.scaling;if(m.get("geometry")){r.setStart(),r.add(m.get("geometry"));var polys=r.setFinish(),sgn="Plateforme Web"===this.model.get("label")?-1:1;polys.transform(["t",-sgn*this.model.get("dx"),-sgn*this.model.get("dy")]),polys.transform(["...S",scaling,scaling,0,0]),this.polys=polys}var ws=utils.getWindowSize(),w=ws.w,h=ws.h,xw=eval(m.get("x"))-(m.get("width")/2*scaling*scaling||0),yh=eval(m.get("y"))-(m.get("height")/2*scaling*scaling||0);return this.$el.css({left:xw,top:yh}),this.X=eval(m.get("x")),this.Y=eval(m.get("y")),this.Xbase=this.X,this.Ybase=this.Y,this.fax=this.X+(m.get("fax")*m.get("w_mod")||0),this.fay=this.Y+(m.get("fay")*m.get("h_mod")||0),this},renderSolution:function(){function a(a){a=3.14*a/180;var g=.2*c,h=e+1.1*c*Math.cos(a),i=f-1.1*d*Math.sin(a),j=e+(c+g)*Math.cos(a),k=f-(d+g)*Math.sin(a);b.path(["M",h,i,"L",j,k]).attr({"stroke-width":3,stroke:"#FFC633"})}if(this.model.get("solution")){var b=Raphael(this.el,1.3*this.w,1.5*this.h);$("svg",this.$el).css({position:"absolute"}),this.$el.children().first().css({top:.25*-this.h,left:.15*-this.w,opacity:0});var c=1*this.w/2,d=1*this.h/2,e=1.3*this.w/2,f=1.5*this.h/2;a(30),a(60),a(90),a(120),a(150),this.$solution=this.$el.children().first(),this.$solution.velocity({opacity:1},{loop:!0})}return this},renderTip:function(){if(this.model.get("label")){this.$label.addClass("show_v");var a=Raphael(this.el,40,30);$("svg",this.$el).css({position:"absolute"}),this.$el.children().first().css({top:.95*this.model.get("h_mod"),left:this.w/2-40,"z-index":1});var b=15,c=40,d=a.path(["M",40-c,0+b,"L",40,0,"L",40-c/2,0+b,"Z"]);d.attr({"stroke-width":0,fill:"#D8D8D9"}),this.$label.html(this.model.get("label")),this.$label.css({top:.95*this.model.get("h_mod")+15,left:this.w/2-40})}return this},close:function(){this.$solution&&this.$solution.velocity("stop"),this.stopListening()},appear:function(a,b){this.onScreen||(this.$el.velocity("fadeIn",{duration:parseInt(a.time),delay:b,queue:!1,display:"block"}),this.onScreen=!0)},disappear:function(a,b){this.$el.velocity("fadeOut",{duration:parseInt(a.time),delay:b,queue:!1}),this.onScreen=!1},translate:function(args,delay){var ws=utils.getWindowSize(),w=ws.w,h=ws.h,m=this.model,scaling=this.scaling,xw=eval(args.x)-(m.get("width")/2*scaling*scaling||0),yh=eval(args.y)-(m.get("height")/2*scaling*scaling||0);this.X=eval(args.x),this.Y=eval(args.y),this.fax=this.X+(m.get("fax")*m.get("w_mod")||0),this.fay=this.Y+(m.get("fay")*m.get("h_mod")||0),this.$el.velocity({left:xw,top:yh},{duration:parseInt(args.time),delay:delay,queue:!1})},hideGround:function(){for(var a=0;a<this.polys.length;a++)"#89807D"===this.polys[a].attr("fill")&&this.polys[a].hide()},showGround:function(){for(var a=0;a<this.polys.length;a++)"#89807D"===this.polys[a].attr("fill")&&this.polys[a].show()}});var app=app||{};app.ItemProjectView=Backbone.View.extend({tagName:"li",className:"itemproject",events:function(){var a={};return this.to_render&&_.extend(a,{mouseenter:"over",mouseleave:"out",click:"clk"}),a},template:_.template('		<div class = "content">      		<div class = "gcontainer"><img class = "graphics" src=<%=imgurl%>></div>      		<div class = "logocontainer hidden">        	<div class = "mask"></div>        		<img src=<%=logourl%>>      		</div>      		<div class = "text">        		<h3 class = "name"><%=name%></h3>      		<div>    	</div>	'),initialize:function(){this.rendered=!0,this.hasLogo=!0,"amu"==this.model.get("logo")?this.model.set("logourl","data/graphics/logoamusmall.png"):"adpd"==this.model.get("logo")?this.model.set("logourl","data/graphics/adpd.png"):(this.model.set("logourl",""),this.hasLogo=!1);var a=["paris","grandparis","valdemarne","px"];this.to_render=!0,a.indexOf(this.model.get("id"))>-1&&(this.to_render=!1)},render:function(){return this.renderContent().cacheComponents(),this},cacheComponents:function(){return this.$logocontainer=this.$el.find(".logocontainer"),this},renderContent:function(){return this.$el.html(this.template(this.model.attributes)),this},over:function(){Backbone.trigger("projects:focus",{id:this.model.get("id")})},hide:function(){this.$el.velocity("fadeOut",{duration:0}),this.$el.addClass("item-hidden"),this.rendered=!1},show:function(){this.$el.velocity("fadeIn",{duration:0,display:"inline-block"}),this.rendered=!0},out:function(){Backbone.trigger("projects:unfocus",{id:this.model.get("id")})},focus:function(){return this.$el.addClass("item-focused"),this.to_render&&this.hasLogo&&this.$logocontainer.show(),this},unfocus:function(){this.$el.removeClass("item-focused"),this.to_render&&this.hasLogo&&this.$logocontainer.hide()},clk:function(){var a=this.model.get("id"),b=["paris","grandparis","valdemarne","px"];b.indexOf(this.model.get("id"))<0&&Backbone.trigger("route:buildGo",{change:"project",id:a})},close:function(){this.stopListening()}});var app=app||{};app.ItemsView=Backbone.View.extend({initialize:function(a){this.parent=a.parent;var b=Backbone.Collection.extend({model:app.ItemView});this.views_collection=new b,this.listenTo(Backbone,"items:animate",this.animate)},render:function(){this.collection.length;return this.collection.each(function(a){var b=function(){Backbone.trigger("item:loaded")};this.views_collection.add({id:a.get("id"),model:a,parent:this,complete:b})},this),this},close:function(){_.each(this.views_collection.models,function(a){a.close(),a.remove()}),this.stopListening()},animate:function(a){var b=this.views_collection.get(a.target);b&&b[a.action](a.parms,a.time)}});var app=app||{};app.NavView=Backbone.View.extend({tagName:"li",className:"n_button",events:{click:"clk"},template:_.template('		<div class="tip border-tip">      		<h3><%=title%></h3>      		<b class="border-notch notch"></b>      		<b class="notch"></b>    	</div>	'),initialize:function(){_.bindAll(this,"renderClean")},render:function(){return this.$el.html(this.template(this.model.attributes)),!this.model.get("display_dot")&&this.$el.addClass("hidden"),this},renderClean:function(){var a=this.$el.find(".tip").width(),b=this.$el.find(".tip").height();this.$el.find(".tip").css({left:.5*-a-3.75,top:-b-25})},clk:function(a){this.$el.parent().children().each(function(){$(this).removeClass("n-clicked")}),this.$el.addClass("n-clicked"),!a.silent&&Backbone.trigger("stories:go",{id:this.id})}});var app=app||{};app.PopProjectView=Backbone.View.extend({className:"popproject",events:{click:"clk",mouseenter:"over",mouseleave:"out"},template:_.template('		<div class="tip border-tip">			<div id = "mousebox"></div>			<p><%=name%></p>			<b class="border-notch notch"></b>			<b class="notch"></b>		</div>		<div id = "pin"></div>	'),initialize:function(a){_.bindAll(this,"renderClean"),this.item=a.item,this.id=this.model.get("id"),this.rendered=!0},render:function(){return this.renderContent().cacheComponents(),this},cacheComponents:function(){return this.$pin=this.$el.find("#pin"),this.$tip=this.$el.find(".tip"),this.$pin.addClass(this.model.get("type")),this},renderContent:function(){return this.$el.html(this.template(this.model.attributes)),this},renderGeometry:function(){var a="local"===this.model.get("type")?"local":"global",b="pin"+a;return this.pin_b=new app.ButtonView({model:app.instance.ui.b_collection.get(b),el:this.$pin}),this},correctPosition:function(){var a=this.item.X,b=this.item.Y,c=this.item.w,d=this.item.h,e=this.item.wBase,f=this.item.hBase,g=this.item.scaling,h=this.item.model.get("geom");if("data/graphics/geom_grandparis.json"==h)var i=a-c/2+1069*parseFloat(this.model.get("x"))*g*g*c/e+344*g*g*c/e,j=b-d/2+393*parseFloat(this.model.get("y"))*g*g*d/f+389*g*g*c/e;else var i=a+c*(parseFloat(this.model.get("x"))-.5),j=b+d*(parseFloat(this.model.get("y"))-.5);this.y=j,this.x=i,this.$el.css({top:j,left:i})},renderClean:function(){this.renderGeometry().correctPosition();var a=this.$tip.width(),b=this.$tip.height(),c="local"===this.model.get("type")?60:40,d="local"===this.model.get("type")?10:15;this.$tip.css({left:.5*-a-d,top:-b-c})},clk:function(){var a=this.id;"px"===a?Backbone.trigger("route:buildGo",{change:"root",id:"p"}):"p0"!==a&&Backbone.trigger("route:buildGo",{change:"project",id:a})},show:function(){this.$el.velocity("fadeIn",{duration:200,display:"block"}),this.rendered=!0},hide:function(){this.$el.velocity("fadeOut",{duration:200}),this.rendered=!1},over:function(){Backbone.trigger("projects:focus",{id:this.id,freezePop:!0}),(this.id.length>3||"px"===this.id)&&this.$tip.addClass("show_h")},out:function(){Backbone.trigger("projects:unfocus",{id:this.id}),(this.id.length>3||"px"===this.id)&&this.$tip.removeClass("show_h")},focus:function(){return this.$el.velocity({top:"-=10"},{duration:300,loop:!0}),this},unfocus:function(){this.$el.velocity("stop",!0).velocity({top:this.y})},close:function(){this.stopListening(),this.pin_b&&this.pin_b.remove()},zOrder:function(a){this.$el.css({"z-index":a})}});var app=app||{};app.ProjectsView=Backbone.View.extend({template:_.template('		<div id = "leftpanel">		<div id = "header">		<div class="form-group">		<input type="text" class="form-control" placeholder="Recherche..."/>		</div>		<i class="icon-search form-control-feedback"></i>		<div id = "categorylist">		<ul></ul>		</div>		<div id = "categoryname">		<p></p>		</div>		<p id = "search_info"></p>		</div>		<div id = "content">		<ul id = "itemlist"></ul>		</div>		</div>		<div id = "rightpanel"></div>		'),events:{"keyup .form-control":"textSearch"},initialize:function(a){this.parent=a.parent,this.items_views=a.items_views.views_collection;var b=Backbone.Collection.extend({model:app.PopProjectView});this.ppv_collection=new b;var c=Backbone.Collection.extend({model:app.ItemProjectView});this.ipv_collection=new c;var d=Backbone.Collection.extend({model:app.CategoryView});this.cat_collection=new d,this.listenTo(Backbone,"projects:focus",this.focusProject),this.listenTo(Backbone,"projects:unfocus",this.unfocusProject),this.listenTo(Backbone,"projects:updatePositions",this.updateProjectsPositions),this.listenTo(Backbone,"categories:focus",this.focusCategory),this.listenTo(Backbone,"categories:unfocus",this.unfocusCategory),this.listenTo(Backbone,"categories:clk",this.clkCategory),this.listenTo(Backbone,"map:pan",this.panMap),this.user_input="",this.projects_ids=[],this.projects_names=[],this.collection.each(function(a,b){this.projects_ids[b]=a.get("id"),this.projects_names[b]=utils.formatString(a.get("name"))},this),this.categoriesData=[{icon:"icon-tous",color:"#9e9e9",label:"Tous les projets",state:"tous_projets"},{icon:"icon-nouveauxmodels",color:"#b4b3b3",label:"Nouveaux modèles économiques",state:"nouveaux_modeles_economiques"},{icon:"icon-eau",color:"#99d2e9",label:"Gestion durable de l'eau",state:"gestion_durable_eau"},{icon:"icon-energies",color:"#fcea27",label:"Récupération et valorisation énergétique",state:"recuperation_valorisation_energetique"},{icon:"icon-matieres",color:"#cbbc9f",label:"Réemploi et réutilisation matières",state:"reemploi_reutilisation_matieres"},{icon:"icon-dechetsverts",color:"#cbbc9f",label:"Valorisation biodéchets et agriculture urbaine",state:"valorisation_biodechets_agriculture_urbaine"},{icon:"icon-chantier",color:"#9cc876",label:"Recyclage et valorisation des déchets de chantier",state:"recyclage_valorisation_dechets_chantier"}],this.clicked_cat="Tous les projets",this.clicked_cat_id=0,a.categoryState&&(this.clicked_cat_id=_.findIndex(this.categoriesData,function(b){return b.state==a.categoryState}),this.clicked_cat=this.categoriesData[this.clicked_cat_id].label),this.cat_matchs=_.clone(this.projects_ids),this.search_matchs=_.clone(this.projects_ids),this.showpanel=a.showpanel,this.allow_pan=!0,this.focus_on_project=a.focus_on_project},render:function(){return this.renderContent().cacheComponents().renderCategories().renderPops().renderItems().attachPan().slidePanel().focusOnProject(),this},slidePanel:function(){return this.showpanel&&this.$leftpanel.velocity({opacity:1},{duration:200,delay:800,easing:"easeOut"}),this},focusOnProject:function(){if(this.focus_on_project){var a=this.ipv_collection.get(this.focus_on_project);this.focused_item=a.focus(),this.focused_item.$el.velocity("scroll",{container:this.$list,duration:0,offset:-64,easing:"easeInOut"})}return this},exitPanel:function(){this.showpanel&&this.$leftpanel.velocity("fadeOut",{duration:300})},renderContent:function(){return this.$el.append(this.template()),this},cacheComponents:function(){return this.$leftpanel=this.$el.find("#leftpanel"),this.$list=this.$leftpanel.find("#itemlist"),this.$input=this.$leftpanel.find(".form-control"),this.$categorylist=this.$leftpanel.find("#categorylist ul"),this.$categoryname=this.$leftpanel.find("#categoryname p"),this.$rightpanel=this.$el.find("#rightpanel"),this.$search_info=this.$el.find("#search_info"),this},attachPan:function(){return this.parent.$itemcontainer.panzoom("option","increment",.2),this.pan_limits=[-.5,.5,-.75,.75],this.parent.$itemcontainer.panzoom("option","limits",this.pan_limits),this.parent.$itemcontainer.on("panzoomstart",_.bind(this.storeTransform,this)),this.parent.$itemcontainer.on("panzoompan",_.bind(this.panMap,this)),this.parent.$itemcontainer.on("panzoomend",_.bind(this.endPan,this)),this.parent.$itemcontainer.on("panzoomzoom",_.bind(this.panMapAfterZoom,this)),this.offsetX=0,this.offsetY=0,this.startX=0,this.startY=0,this.previous_zoom=1,this.next_zoom=1,this},panMap:function(a,b,c,d){function e(a,b,c,d){var e=$("#itemcontainer").width(),f=$("#itemcontainer").height(),g=this.pan_limits[0]*e,h=this.pan_limits[1]*e,i=this.pan_limits[2]*f,j=this.pan_limits[3]*f;i>d?a.css("top",i):d>j?a.css("top",j):a.css("top",d+1*(this.startY-this.offsetY)),g>c?a.css("left",g):c>h?a.css("left",h):a.css("left",c+1*(this.startX-this.offsetX))}_.bind(e,this)(this.$rightpanel,b,c,d)},endPan:function(){this.offsetX=parseFloat(this.$rightpanel.css("left")),this.offsetY=parseFloat(this.$rightpanel.css("top"))},storeTransform:function(a,b){var c=b.getMatrix()[0];this.previous_zoom=c,this.offsetX=b.getMatrix()[4],this.offsetY=b.getMatrix()[5],this.startX=parseFloat(this.$rightpanel.css("left")),this.startY=parseFloat(this.$rightpanel.css("top"))},panMapAfterZoom:function(a,b){var c=parseFloat(b.getMatrix()[0]);this.previous_zoom=this.next_zoom,Math.abs(c-this.previous_zoom)>.001&&(this.next_zoom=c)},updateProjectsPositions:function(){this.renderPops(),Backbone.trigger("territory:updateProjects")},wheelZoom:function(a){a.preventDefault();var b=a.deltaY||a.originalEvent.wheelDelta,c=b?0>b:a.originalEvent.deltaY>0,d=this.previous_zoom+b/100*2;$("#zoom").find(".zoom-range").val(100*d-50),this.parent.$itemcontainer.panzoom("zoom",c,{increment:Math.abs(b)/100*2,animate:!1,focal:a}),mat=this.parent.$itemcontainer.panzoom("getMatrix").input;var e={clientX:a.clientX,clientY:a.clientY},f=this.parent.$itemcontainer.panzoom("instance");_.bind(this.reloadPins(a,f,mat,e,c),this)()},reloadPins:function(a,b,c,d,e){var f=this;return function(){clearTimeout(f.doit),f.panMapAfterZoom(a,b),f.doit=setTimeout(function(){Backbone.trigger("items:updatePositions",{mat:c,ws:d,z:e}),Backbone.trigger("projects:updatePositions",{mat:c,ws:d,z:e})},200)}},renderPops:function(){this.collection.each(function(a){if(a.get("render")){var b=this.ppv_collection.add({id:a.get("id"),model:a,item:this.items_views.get(a.get("territory"))});this.$rightpanel.append(b.render().el),_.defer(b.renderClean)}},this);var a=this;return _.defer(function(){function b(a,b){var c=a.model.get("type"),d=b.model.get("type");return c===d?a.y-b.y:"global"==d?-1:1}var c=a.ppv_collection.models;c.sort(b);for(var d=c.length;d--;)a.ppv_collection.get(c[d].id).zOrder(d)}),this},renderCategories:function(){return _.each(this.categoriesData,function(a,b){var c=b==this.clicked_cat_id?!0:!1,d=this.cat_collection.add({id:b,model:a,clicked:c});this.$categorylist.append(d.render().el)},this),this},renderItems:function(){var a=["paris","grandparis","valdemarne","px"];return this.collection.each(function(b){var c=this.ipv_collection.add({id:b.get("id"),model:b});if(a.indexOf(b.get("id"))<0){var d=c.render();this.$list.append(d.el),d.$el.velocity("scroll",{container:this.$list,duration:0,offset:-64,easing:"easeInOut"})}},this),this.filterItemsByCat(this.clicked_cat_id),this},showProject:function(a){var b=this.ppv_collection.get(a.model.attributes.id);
!a.rendered&&a.show(),b&&!b.rendered&&b.show()},hideProject:function(a){var b=this.ppv_collection.get(a.model.attributes.id);a.rendered&&a.hide(),b&&b.rendered&&b.hide()},filterItemsByCat:function(a){this.ipv_collection.each(function(b){0!==a&&-1==_.indexOf(b.model.attributes.category,a)?this.hideProject(b):this.showProject(b)},this)},filterItemsById:function(){var a=(this.clicked_cat_id,_.intersection(this.search_matchs,this.cat_matchs)),b=_.difference(this.projects_ids,a),c=_.select(this.ipv_collection.models,function(a){return _.indexOf(b,a.id)>-1}),d=_.select(this.ipv_collection.models,function(b){return _.indexOf(a,b.id)>-1});this.user_input.length>2?""!==this.user_input&&this.$search_info.html("<b>"+d.length+"</b> résultats pour : <b>"+this.user_input.split(/[\s,]+/).join("</b> + <b>")+"</b>"):this.$search_info.html(""),_.each(c,function(a){this.hideProject(a)},this),_.each(d,function(a){this.showProject(a)},this)},textSearch:function(){var a=this.$input.val(),b=utils.formatString(a).split(/[\s,]+/);this.user_input=a;var c=[],d=0;_.each(b,function(a){var b=_.filter(this.projects_names,function(b){return-1!==b.indexOf(a)}),e=[],f=0;_.each(b,function(a){e[f]=_.indexOf(this.projects_names,a),f++},this),c[d]=e,d++},this);var e=_.intersection.apply(_,c),f=[];d=0,_.each(e,function(a){f[d]=this.projects_ids[a],d++},this),this.search_matchs=f,this.filterItemsById()},focusCategory:function(a){this.$categoryname.html(a.label)},unfocusCategory:function(){this.$categoryname.html(this.clicked_cat)},clkCategory:function(a){if(!a.options.silent){this.cat_collection.each(function(b){b.model.label!=a.label&&b.unclk()}),this.clicked_cat=a.label,this.clicked_cat_id=a.id,this.cat_matchs=[];var b=0;this.ipv_collection.each(function(c){_.indexOf(c.model.attributes.category,a.id)>-1&&(this.cat_matchs[b]=c.id,b++)},this),this.filterItemsById()}},focusProject:function(a){var b=["paris","grandparis","valdemarne","px"];if(b.indexOf(a.id)<0){var c=this.ipv_collection.get(a.id);if(this.focused_pop&&this.focused_pop.unfocus(),this.focused_item&&this.focused_item.unfocus(),"global"!==c.model.get("type"))this.focused_id=a.id,a.freezePop||(this.focused_pop=this.ppv_collection.get(a.id).focus());else{var d=c.model.get("coverage");this.focused_id=d,a.freezePop||(this.focused_pop=this.ppv_collection.get(d).focus())}this.focused_item=c.focus(),a.freezePop&&this.focused_item.$el.velocity("scroll",{container:this.$list,duration:1e3,offset:-64,easing:"easeInOut"})}else if("px"!==a.id){var e=_.select(this.ipv_collection.models,function(b){return"global"===b.model.get("type")&&b.model.get("coverage")===a.id});this.focused_items={};var f=!0;_.each(e,function(a){this.focused_items[a.model.get("id")]=a,a.focus(),f&&(a.$el.velocity("scroll",{container:this.$list,duration:1e3,offset:-64,easing:"easeInOut"}),f=!f)},this)}},unfocusProject:function(a){var b=["paris","grandparis","valdemarne","px"];b.indexOf(a.id)<0?(this.focused_pop&&this.focused_pop.unfocus(),this.focused_item&&this.focused_item.unfocus(),this.focused_item&&this.focused_item.$el.velocity("stop")):_.each(this.focused_items,function(a){a.unfocus()})},close:function(){this.$leftpanel.velocity("stop"),this.focused_item&&this.focused_item.$el.velocity("stop"),this.focused_pop&&this.focused_pop.$el.velocity("stop"),_.each(this.ppv_collection.models,function(a){a.close(),a.remove()}),_.each(this.ipv_collection.models,function(a){a.close(),a.remove()}),this.stopListening()},updatePops:function(){this.$leftpanel.velocity("stop"),this.focused_item&&this.focused_item.$el.velocity("stop"),this.focused_pop&&this.focused_pop.$el.velocity("stop"),_.each(this.ppv_collection.models,function(a){a.close(),a.remove()})}});var app=app||{};app.PulseView=Backbone.View.extend({className:"pulse",initialize:function(a){this.parent=a.parent,this.parms=_.pick(this.parent.model.attributes,"col","sw")},render:function(){return this.renderPulse(),this},renderPulse:function(){function a(){$.Velocity.RunSequence(i)}for(var b=this.parent.path,c=[],d=10,e=(b.getTotalLength(),0);e<b.getTotalLength();){var f=b.getPointAtLength(e);c.push({x:f.x,y:f.y}),e+=d}this.pulsePath=c;var g=this.parms.sw,h=-Math.round(g/2);this.$el.css({width:g,height:g,"margin-top":h,"margin-left":h,"background-color":this.parms.col});var i=[{elements:this.$el,properties:{top:c[0].y,left:c[0].x},options:{duration:0}},{elements:this.$el,properties:{top:c[Math.floor((c.length-1)/4)].y,left:c[Math.floor((c.length-1)/4)].x},options:{duration:1e3,easing:"linear"}},{elements:this.$el,properties:{top:c[Math.floor((c.length-1)/2)].y,left:c[Math.floor((c.length-1)/2)].x},options:{duration:1e3,easing:"linear"}},{elements:this.$el,properties:{top:c[Math.floor(3*(c.length-1)/4)].y,left:c[Math.floor(3*(c.length-1)/4)].x},options:{duration:1e3,easing:"linear"}},{elements:this.$el,properties:{top:c[c.length-1].y,left:c[c.length-1].x},options:{duration:1e3,easing:"linear",complete:a}}];return $.Velocity.RunSequence(i),this}});var app=app||{};app.RadioView=Backbone.View.extend({initialize:function(){this.buttonsViews=[],this.$buttons=this.$el.children().first().children(),_.each(this.$buttons,this.addButton,this)},addButton:function(a){var b=new app.Button({change:"root",id:"about"});this.buttonsViews.push(new app.ButtonView({model:b,el:a}))}});var app=app||{};app.StartView=Backbone.View.extend({id:"start",template:_.template('  		<div id = "warning"><p><%= warningText %></p></div>		<div id = "backstart">			<div id = "rstart"></div>			<div id = "tstart">      			<h1><%= startTitle %></h1>      			<p><%= startText %></p>      			<div id = "launch"><p>Explorer</p></div>      			<div id = "demo"><p>Démo</p></div>    		</div>		</div>    	<div id = "foot_logos">      		<ul>        		<li><a href = "http://www.paris.fr/" target="_blank"><img src = "./data/graphics/logo-mdp.gif"/></a></li>      		</ul>    	</div>	'),events:{"click #launch":"launch","click #demo":"demo","mouseover #tstart":"addCircle"},initialize:function(){var a=Backbone.Collection.extend({model:app.CircleView});this.views_collection=new a},render:function(a){return this.$el.html(this.template(this.model.attributes)),a=a||{},this.adjustVertically(a),this.renderRaphael(),this},adjustVertically:function(a){var b=a.dz||0;return this.$el.addClass(0>b?"up":b>0?"down":"middle"),this},renderRaphael:function(){var a=this.$el.find("#rstart"),b=Raphael(a[0],800,800);this.paper=b,this.cx=400,this.cy=400;var c=Math.floor(500+500*Math.random()),d=Math.floor(250+500*Math.random()),e=this;this.clockAddCircle=setInterval(function(){e.addCircle()},c),this.clockKillCircle=setInterval(function(){e.killCircle()},d)},addCircle:function(){if(this.views_collection.models.length<12){var a=new app.Circle({cx:this.cx,cy:this.cy}),b=this.views_collection.add({model:a,paper:this.paper,circles:this.circles});b.render()}},killCircle:function(){if(this.views_collection.models.length>0){var a=Math.floor(this.views_collection.models.length*Math.random()),b=this.views_collection.at(a).close();this.views_collection.remove(b)}},stopAllListening:function(){this.stopListening()},close:function(){this.stopListening(),clearInterval(this.clockAddCircle),clearInterval(this.clockKillCircle),_.each(this.views_collection.models,function(a){a.close(),a.remove()}),this.paper.remove()},transitionIn:function(a){var b=a.callback?_.bind(this[a.callback],this):function(){};this.$el.velocity({top:"0%"},{duration:1e3,complete:b}),$("#foot_logos").velocity("fadeIn",{duration:200})},transitionOut:function(a){var b=a.dz||0,c="0%";return 0===b?void a.callback():(b>0?c="-100%":0>b&&(c="100%"),this.$el.velocity({top:c},{duration:1e3,complete:a.callback}),void $("#foot_logos").velocity("fadeOut",{duration:200}))},launch:function(){Backbone.trigger("route:buildGo",{change:"territory",id:"paris"})},demo:function(){Backbone.trigger("ui:demo")}});var app=app||{};app.StoriesView=Backbone.View.extend({id:"footer",template:_.template('		<div id = "nav"><ul></ul></div>    	<div id = "title"><h2></h2><p></p></div>    	<div id = "story">      		<ul>        		<li id = "previous" class = "s_button"><span>Info précédente</span></li>        		<li id = "next" class = "s_button"><span>Plus d‘infos</span></li>        		<li id = "tcontainer"><p id = "s_text"></p></li>      		</ul>    	</div>	'),events:{"click #previous":"previous","click #next":"next"},initialize:function(){this.listenTo(Backbone,"stories:go",this.go);var a=Backbone.Collection.extend({model:app.NavView});this.nv_collection=new a,this.i=-1,this.s=0},cacheComponents:function(){return this.$title=this.$el.find("#title h2"),this.$subtitle=this.$el.find("#title p"),this.$text=this.$el.find("#s_text"),this.$previous=this.$el.find("#previous"),this.$next=this.$el.find("#next"),this.$nav=this.$el.find("#nav ul"),this},render:function(){this.renderContent().cacheComponents().renderNav();var a=this;return _.defer(function(){a.attachButtons()}),this},renderContent:function(){return this.$el.html(this.template()),this},renderNav:function(){return this.collection.each(function(a,b){var c=new Backbone.Model({id:b,title:a.get("title"),display_dot:a.get("display_dot")}),d=this.nv_collection.add({id:b,model:c});this.$nav.append(d.render().el),_.defer(d.renderClean)},this),this},close:function(){_.each(this.nv_collection.models,function(a){a.stopListening(),a.remove()}),this.previous_b.remove(),this.next_b.remove()},go:function(a){var b="last"===a.id?this.collection.models.length-1:a.id;if(this.collection.models[b]){var c=this.collection.models[b].get("steps");c.length>1&&this.showNext(),this.injectContent(b,0,1),this.nv_collection.get(b).clk({silent:!0})}},nextStep:function(a){var b=a.dir,c=this.collection.models[this.i].get("steps");if(!(0===this.s&&-1===b||this.s===c.length-1&&1===b)){this.s=this.s+b;var d=this.s;0===d?(this.$previous.css({display:"none"}),this.$next.css({display:"inline-block"})):d>0&&d<c.length-1?(this.$previous.css({display:"inline-block"}),this.$next.css({display:"inline-block"})):(this.$next.css({display:"none"}),this.$previous.css({display:"inline-block"})),this.injectContent(this.i,d,b)}},injectContent:function(a,b,c){function d(){return function(){e.$title.html(g[b].subtitle),e.$text.html(g[b].text.content)}}var e=this;this.i=a;var f=e.collection.models[a],g=f.get(1===c?"steps":"b_steps"),h={elements:this.$title,properties:{opacity:0},options:{duration:200,complete:d()}},i={elements:this.$text,properties:{opacity:0},options:{duration:200,sequenceQueue:!1}},j={elements:this.$title,properties:{opacity:1},options:{duration:200}},k={elements:this.$text,properties:{opacity:1},options:{duration:200,sequenceQueue:!1}};$.Velocity.RunSequence([h,i,j,k]);var l=g[b],m=l.flows,n=m.length;if(0!==n)for(;n--;)!function(a){setTimeout(function(){var b=m[a],c=b.type,d=b.vl,e=b.hl,f=b.popups,g="o4"===b.year?1:2;scaling=b.scaling,mt=b.mt,Backbone.trigger("flows:nav",{vl:d,hl:e,popups:f,time:g,scaling:scaling,mt:mt}),Backbone.trigger("route:forceState",{state:{typeState:c,timeState:String(g)}})},parseInt(m[a].time))}(n);var l=g[b],o=l.territories,p=o.length;if(0!==p)for(;p--;)Backbone.trigger("items:animate",o[p])},attachButtons:function(){this.previous_b=new app.ButtonView({model:app.instance.ui.b_collection.get("previous"),el:this.$previous}),this.next_b=new app.ButtonView({model:app.instance.ui.b_collection.get("next"),el:this.$next})},showNext:function(){this.$next.css({display:"inline-block"})},previous:function(){this.nextStep({dir:-1})},next:function(){this.nextStep({dir:1})},arrowKeyPressed:function(a){var b=a.keyCode;39==b&&"none"!==$("#next").css("display")?this.next():37==b&&"none"!==$("#previous").css("display")&&this.previous()}});var app=app||{};app.TerritoriesView=Backbone.View.extend({initialize:function(a){this.territories=new Backbone.Collection,this.territories.add(a.init),this.currentView=null},addTerritoryView:function(a){this.CurrentView,new app.TerritoryView({model:this.territories.get(a.id),time:a.time,type:a.type,mt:a.mt,"goto":_.bind(app.instance.goto,app.instance)})},close:function(){this.previousView.close(),this.previousView.remove()}});var app=app||{};app.TerritoryView=Backbone.View.extend({id:"territory",template:_.template('		<div id = "leftpanel"></div>		<div id = "flowcontainer" class = "hidden"></div>  		<div id = "itemcontainer"><div id = "items"></div></div>  		<div id = "projectcontainer"></div>  		<div id = "popcontainer"></div>  		<div id = "storycontainer"></div>	'),initialize:function(a){this.intro=a.intro;var b=this.model.get("data_url"),c=this;this.init_time=a.time,$.ajax({url:b,data:{get_param:"value"},dataType:"json",success:function(b){var d=new Backbone.Collection(b.items);c.items_views=new app.ItemsView({parent:c,collection:d}),c.items_number=d.length;var e=new Backbone.Collection(b.flows,{model:app.Flow});if(c.flows_views=new app.FlowsView({parent:c,collection:e,items_views:c.items_views}),b.projects){var f=_.filter(b.projects,function(a){return a.hidden!==!0}),g=new Backbone.Collection(f),h="projects"===c.model.get("id"),i={parent:c,collection:g,items_views:c.items_views,showpanel:h,focus_on_project:a.focus_on_project,categoryState:a.categoryState};c.projects_views=new app.ProjectsView(i)}var j=new Backbone.Collection(b.stories[a.type]);c.stories_views=new app.StoriesView({collection:j}),a.goto(c)}}),this.listenTo(Backbone,"item:loaded",this.itemsCountDown),this.listenTo(Backbone,"territory:updateProjects",this.updateProjects)},updateProjects:function(){this.projects_views&&this.$projectcontainer.append(this.projects_views.el)},itemsCountDown:function(){if(this.items_number--,0==this.items_number){if(this.projects_views&&this.$projectcontainer.append(this.projects_views.render().el),Backbone.trigger("stories:go",{id:0}),this.intro){var a=new app.IntroView;$("body").append(a.render().el),a.$back.velocity({opacity:.6},{duration:300,delay:750}),this.iv=a}this.$storycontainer.velocity("fadeIn",{duration:300,delay:200}),this.$flowcontainer.velocity("fadeIn",{duration:300,delay:200}),this.$popcontainer.velocity("fadeIn",{duration:300,delay:200}),$("#flowscale").velocity("fadeIn",{duration:300,delay:200})}},render:function(a){return a=a||{},this.adjustVertically(a),this.$el.html(this.template()),this.$itemcontainer=this.$el.find("#itemcontainer"),this.$items=this.$el.find("#items"),this.$flowcontainer=this.$el.find("#flowcontainer"),this.$projectcontainer=this.$el.find("#projectcontainer"),this.$storycontainer=this.$el.find("#storycontainer"),this.$popcontainer=this.$el.find("#popcontainer"),this.items_views.render(),this.$storycontainer.append(this.stories_views.render().el),this},adjustVertically:function(a){var b=a.dz||0;return this.$el.addClass(0>b?"up":b>0?"down":"middle"),this},stopAllListening:function(){this.stopListening(),this.items_views.stopListening(),this.$itemcontainer.panzoom()&&this.$itemcontainer.panzoom("destroy"),this.flows_views.stopListening(),this.stories_views.stopListening(),this.projects_views&&this.projects_views.stopListening(),this.iv&&this.iv.stopListening()},close:function(){this.items_views.close(),this.flows_views.close(),this.stories_views.close(),this.items_views.remove(),this.flows_views.remove(),this.stories_views.remove(),this.projects_views&&(this.projects_views.close(),this.projects_views.remove()),this.iv&&this.iv.close(),this.stopListening()},transitionIn:function(){var a=function(){};this.$itemcontainer.velocity("fadeIn",{duration:300}),this.$el.velocity({top:"0%"},{duration:1e3,complete:a})},transitionOut:function(a){this.$itemcontainer.velocity("fadeOut",{duration:300,delay:300}),this.$storycontainer.velocity("fadeOut",{duration:300,delay:300}),this.$flowcontainer.velocity("fadeOut",{duration:300,delay:300}),this.$popcontainer.velocity("fadeOut",{duration:300,delay:300}),this.projects_views&&this.projects_views.exitPanel();var b=a.dz||0,c="0%";return 0===b?void a.callback():(b>0?c="-100%":0>b&&(c="100%"),void this.$el.velocity({top:c},{duration:1e3,complete:a.callback}))}});var app=app||{};app.UIView=Backbone.View.extend({el:"#ui",events:{"click #share":"popShare","click #expand":"expandFlows","click #contract":"contractFlows","click #about_b":"about"},initialize:function(a,b){this.parent=a,this.buttons={},this.b_collection=new Backbone.Collection,this.listenTo(this.b_collection,"add",this.addButton),this.b_collection.add(b.init),this.listenTo(Backbone,"ui:route",this.updateButtons),this.listenTo(Backbone,"ui:clickRadio",this.clickRadio),this.listenTo(Backbone,"ui:scale",this.updateScale),this.listenTo(Backbone,"ui:demo",this.demo),this.listenTo(Backbone,"ui:closeDemo",this.unloadDemo),this.renderScale(),$("#share").on("click",_.bind(this.popShare,this)),$("#expand").on("click",_.bind(this.expandFlows,this)),$("#contract").on("click",_.bind(this.contractFlows,this)),$("#about_b").on("click",_.bind(this.about,this)),_.bindAll(this,"about","unloadAbout","demo","unloadDemo")},renderScale:function(){var a=Raphael($("#fs_container div")[0],100,200),b=a.path();this.Rscale=b},updateScale:function(a){var b=Math.round(.008/a.scale)/1e-4,c=b*a.scale;2>c?($("#fs_container").hide(),$("#fs_text").hide()):a.virtual||($("#legend").velocity("fadeIn",{duration:200,display:"block",delay:1e3}),$("#fs_container").show(),$("#fs_text").show(),$("#fs_container div").css({height:c+10}),this.Rscale.attr({path:["M",30,c+5,"H",25,"V",5,"H",30],"stroke-width":3,stroke:"#ccc"}),$("#legend #fs_text p").html(utils.formatVolume(b," ")+" "+a.unit))},addButton:function(a){$(a.get("el")).length>0&&(this.buttons[a.get("id")]=new app.ButtonView({model:a,el:$(a.get("el"))}))},showButtons:function(a,b){args=a.model?a.model.get("ui_elements"):a,a=a.model?a:this.parent.currentPage;var c=b||0;$("#legend").velocity("fadeOut",{duration:200}),_.each(this.buttons,function(a){a.model.get("show_class");a.$el.velocity("fadeOut",{duration:200})}),a.$itemcontainer&&a.$itemcontainer.panzoom("destroy"),$("#zoom").find(".zoom-range").off(),$("#zoom").find(".zoom-range").val(50),this.p_showed_buttons=this.showed_buttons,this.showed_buttons=args;for(var d=args.length;d--;){var e=this.buttons[args[d]],f=e.model.get("show_class");if(this.buttons[args[d]].$el.velocity("fadeIn",{display:f,duration:200,delay:c}),"zoom"==args[d]){var g=a.$itemcontainer.panzoom(),h=this;h.startZoom=$("#zoom").find(".zoom-range").val(),$("#zoom").find(".zoom-range").on("mousedown",function(){h.startZoom=1*this.value}),$("#zoom").find(".zoom-range").on("mouseup",function(){var a=h.startZoom-this.value;h.startZoom=this.value;var b=a>0;lpw=$("#leftpanel").width(),ws=utils.getWindowSize(),ws={clientX:.5*lpw+.5*ws.w,clientY:.5*ws.h},g.panzoom("zoom",b,{increment:Math.abs(a)/100,animate:!0,focal:ws}),mat=g.panzoom("getMatrix").input,Backbone.trigger("items:updatePositions",{mat:mat,ws:ws}),Backbone.trigger("projects:updatePositions",{mat:mat,ws:ws})})}}},clickRadio:function(a){for(var b=this.buttons[a.id].model.get("radio"),c=b.length;c--;){var d=b[c];this.buttons[d].unclick()}},updateButtons:function(a){var b=a.state;"p"===b.rootState&&this.buttons[b.rootState].clk({silent:!0}),null!==b.territoryState&&"p"!==b.rootState&&this.buttons[b.territoryState].clk({silent:!0}),null!==b.typeState&&this.buttons[b.typeState].clk({silent:!0}),null!==b.timeState&&this.toggleTime(b)},popShare:function(){var a=window.screen.availWidth,b=window.screen.availHeight;window.open("html/share.html","popUpWindow","height=100,width=400,left="+a/2+",top="+b/2+",resizable=no,scrollbars=no,toolbar=no,menubar=no,location=no,directories=no,status=no")},toggleTime:function(a){var b=this.buttons.time.$el,c=b.find(".toggle"),d=b.find(".toggle span");$("#trend_legend").removeClass("show_h"),"2"===a.timeState?(c.addClass("toggle-right"),"matter"===a.typeState?(d.html("Tendances"),$("#trend_legend").addClass("show_h")):d.html("energy"===a.typeState?"2009":"2012")):(c.removeClass("toggle-right"),d.html("matter"===a.typeState?"2003":"2004"))},toggleX:function(){var a=this.buttons.about,b=a.$el.find("span");this.about_clicked?(this.about_clicked=!1,b.html("i"),b.addClass("i-info"),b.removeClass("x-info")):(this.about_clicked=!0,b.html("x"),b.removeClass("i-info"),b.addClass("x-info"))},about:function(){this.showButtons(["about"]),this.toggleX(),this.about_view=new app.AboutView,this.$el.first().append(this.about_view.render().el),$("#about_b").off("click"),$("#about_b").on("click",_.bind(this.unloadAbout,this))},unloadAbout:function(){this.showButtons(this.p_showed_buttons),this.toggleX(),this.about_view.close(),$("html, body").scrollTop(0),$("body").removeClass("scrollable"),$("#about_b").off("click"),$("#about_b").on("click",_.bind(this.about,this))},demo:function(){this.demo_view=new app.DemoView,this.$el.append(this.demo_view.render().el)},unloadDemo:function(){this.demo_view.close(),this.demo_view.remove()},expandFlows:function(){Backbone.trigger("flows:expand",{type:app.instance.router.state.typeState})},contractFlows:function(){Backbone.trigger("flows:contract",{type:app.instance.router.state.typeState})}});